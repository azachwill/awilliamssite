# .github/workflows/cert_renewal.yml
name: "Bi-Weekly Let's Encrypt Renewal Check"

on:
  schedule:
    # Runs every 14 days at 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  SSH_USER: ubuntu
  SSH_HOST: 3.236.254.88
  EMAIL_RECIPIENT: andrewwilliams1275@gmail.com
  SERVER_DOMAIN: andrewwilliams.website

jobs:
  run-renewal-script:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH Connection
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}

      - name: Add External Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${{ env.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Execute Remote Renewal and Email Script
        run: |
          # Simplified SSH command
          ssh ${{ env.SSH_USER }}@${{ env.SSH_HOST }} 'bash -s' << 'EOF'
            
            # --- Inject GitHub/YAML Environment Variables into Shell ---
            SERVER_DOMAIN="${{ env.SERVER_DOMAIN }}"
            EMAIL_RECIPIENT="${{ env.EMAIL_RECIPIENT }}"
            
            # --- 1. Attempt Renewal ---
            sudo certbot renew --quiet --post-hook "systemctl reload apache2 || systemctl reload nginx"
            
            # --- 2. Check and Email Report ---
            # Capture the return code of certbot immediately if needed, 
            # but usually we check if the file changed or logs updated.
            
            # Grepping the log for specific success message
            RENEWAL_SUCCESS=$(grep "The following previously issued certificate has been renewed" /var/log/letsencrypt/letsencrypt.log | tail -n 1)

            if [ -n "$RENEWAL_SUCCESS" ]; then
                
                # --- CORRECTED BLOCK BELOW ---
                # We use printf or echo to avoid nested heredoc YAML indentation issues
                # This constructs the email body safely within the YAML structure
                
                EMAIL_BODY="The automated renewal process completed successfully.\nCertificate Renewed: \"${SERVER_DOMAIN}\"\nDate: $(date)\nFull Log Message: \"$RENEWAL_SUCCESS\""

                echo -e "$EMAIL_BODY" | /usr/bin/mail -s "SUCCESS: Lets Encrypt Certificate Renewed for ${SERVER_DOMAIN}" "${EMAIL_RECIPIENT}"
                
            else
                echo "Renewal check OK. No renewal was necessary at this time, or Certbot produced no 'renewed' output."
            fi
          EOF
